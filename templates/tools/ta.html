<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>技術分析 | Taiwan Stock Pro</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet" />
  <link href="{{ url_for('static', filename='enhanced-ui.css') }}" rel="stylesheet" />
  <link href="{{ url_for('static', filename='mobile-responsive.css') }}" rel="stylesheet" />
</head>
<body>
  <nav class="enhanced-navbar">
    <div class="container-fluid">
      <div class="enhanced-navbar-content">
        <div class="enhanced-navbar-brand">
          <a href="{{ url_for('home') }}" class="brand-link">
            <div class="brand-icon"><i class="bi bi-graph-up-arrow"></i></div>
            <div class="brand-text">
              <span class="brand-name">Taiwan Stock</span>
              <span class="brand-subtitle">Pro</span>
            </div>
          </a>
        </div>
        <div class="enhanced-navbar-user">
          <a href="{{ url_for('home') }}" class="btn-enhanced btn-enhanced-ghost btn-enhanced-sm">
            <i class="bi bi-house"></i>
            <span class="d-none d-md-inline">首頁</span>
          </a>
        </div>
      </div>
    </div>
  </nav>

  <div class="container my-4">
    <div class="row justify-content-center">
      <div class="col-lg-10">
        <div class="card-enhanced animate-slide-in-up">
          <div class="card-enhanced-header d-flex align-items-center justify-content-between">
            <h5 class="mb-0 text-enhanced-primary" style="font-size: 1.125rem; font-weight: 600;">
              <i class="bi bi-graph-up text-primary me-2"></i>技術分析
            </h5>
          </div>
          <div class="card-enhanced-body">
            <form class="row g-3" onsubmit="event.preventDefault(); loadTaChart();">
              <div class="col-sm-4">
                <label class="form-label">股票代碼</label>
                <input type="text" class="form-control-enhanced" id="ta-code" placeholder="如 2330" required />
              </div>
              <div class="col-sm-4">
                <label class="form-label">期間</label>
                <select id="ta-days" class="form-control-enhanced">
                  <option value="3">3 天</option>
                  <option value="7" selected>7 天</option>
                  <option value="14">14 天</option>
                  <option value="30">30 天</option>
                </select>
              </div>
              <div class="col-sm-4 d-flex align-items-end">
                <button class="btn-enhanced btn-enhanced-primary" type="submit">
                  <i class="bi bi-play-circle"></i>
                  <span>載入</span>
                </button>
              </div>
            </form>

            <div class="card-enhanced mt-4">
              <div class="card-enhanced-header d-flex align-items-center justify-content-between">
                <h6 class="mb-0">價格走勢與技術指標</h6>
                <div class="d-flex gap-2">
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="toggleMA" checked>
                    <label class="form-check-label" for="toggleMA">MA5/MA10</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="toggleRSI" checked>
                    <label class="form-check-label" for="toggleRSI">RSI</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="toggleMACD">
                    <label class="form-check-label" for="toggleMACD">MACD</label>
                  </div>
                </div>
              </div>
              <div class="card-enhanced-body">
                <div id="ta-loading" class="loading-enhanced-container" style="display:none;">
                  <div class="loading-enhanced-spinner"></div>
                  <p class="loading-enhanced-text">載入中...</p>
                </div>
                <div class="chart-container" style="height:420px">
                  <canvas id="taChart"></canvas>
                </div>
                <div class="chart-container mt-3" id="rsiSection" style="height:160px">
                  <canvas id="rsiChart"></canvas>
                </div>
                <div class="chart-container mt-3" id="macdSection" style="height:200px; display:none;">
                  <canvas id="macdChart"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script>
    let taChart = null; let rsiChart = null; let macdChart = null;
    async function loadTaChart(){
      const code = document.getElementById('ta-code').value.trim();
      const days = document.getElementById('ta-days').value;
      if(!code){ return; }
      const loading = document.getElementById('ta-loading');
      loading.style.display = 'block';
      try{
        const res = await fetch(`/api/stock/${code}/chart?days=${days}`);
        const data = await res.json();
        loading.style.display = 'none';
        if(!data.success || !data.data || data.data.length===0){
          alert('無法載入資料');
          return;
        }
        const labels = data.data.map(x=>x.time);
        const prices = data.data.map(x=>x.price);
        const ma5 = movingAverage(prices, 5);
        const ma10 = movingAverage(prices, 10);
        const rsi = calcRSI(prices, 14);
        const { macdLine, signalLine, hist } = calcMACD(prices, 12, 26, 9);
        renderTaChart(labels, prices, ma5, ma10);
        renderRSI(labels, rsi);
        renderMACD(labels, macdLine, signalLine, hist);
      }catch(e){
        loading.style.display = 'none';
        alert('載入失敗');
      }
    }

    function movingAverage(arr, n){
      const out = [];
      for(let i=0;i<arr.length;i++){
        const start = Math.max(0, i-n+1);
        const slice = arr.slice(start, i+1);
        const avg = slice.reduce((a,b)=>a+b,0)/slice.length;
        out.push(Number.isFinite(avg)? Number(avg.toFixed(2)) : null);
      }
      return out;
    }

    function renderTaChart(labels, prices, ma5, ma10){
      const ctx = document.getElementById('taChart').getContext('2d');
      if(taChart){ taChart.destroy(); }
      const showMA = document.getElementById('toggleMA').checked;
      taChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            { label: '收盤', data: prices, borderColor: '#3B82F6', backgroundColor: 'rgba(59,130,246,0.1)', tension: 0.3 },
            { label: 'MA5', data: ma5, borderColor: '#10B981', backgroundColor: 'transparent', tension: 0.3, hidden: !showMA },
            { label: 'MA10', data: ma10, borderColor: '#F59E0B', backgroundColor: 'transparent', tension: 0.3, hidden: !showMA }
          ]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } }
      });
    }

    function renderRSI(labels, rsi){
      const sec = document.getElementById('rsiSection');
      sec.style.display = document.getElementById('toggleRSI').checked ? 'block' : 'none';
      const ctx = document.getElementById('rsiChart').getContext('2d');
      if(rsiChart){ rsiChart.destroy(); }
      rsiChart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: [
          { label: 'RSI(14)', data: rsi, borderColor: '#8B5CF6', backgroundColor: 'transparent', tension: 0.2 },
          { label: '70', data: labels.map(()=>70), borderColor: '#EF4444', borderDash:[6,6], pointRadius:0 },
          { label: '30', data: labels.map(()=>30), borderColor: '#10B981', borderDash:[6,6], pointRadius:0 },
        ]},
        options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'top'} }, scales:{ y:{ suggestedMin:0, suggestedMax:100 } } }
      });
    }

    function renderMACD(labels, macdLine, signalLine, hist){
      const sec = document.getElementById('macdSection');
      sec.style.display = document.getElementById('toggleMACD').checked ? 'block' : 'none';
      const ctx = document.getElementById('macdChart').getContext('2d');
      if(macdChart){ macdChart.destroy(); }
      macdChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { type:'line', label: 'MACD', data: macdLine, borderColor:'#0EA5E9', backgroundColor:'transparent', tension:0.2 },
            { type:'line', label: 'Signal', data: signalLine, borderColor:'#F59E0B', backgroundColor:'transparent', tension:0.2 },
            { label: 'Histogram', data: hist, backgroundColor: hist.map(v=> v>=0 ? 'rgba(16,185,129,0.5)' : 'rgba(239,68,68,0.5)') }
          ]
        },
        options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'top'} } }
      });
    }

    function ema(values, period){
      const k = 2/(period+1);
      const emaArr = [];
      let prev;
      for(let i=0;i<values.length;i++){
        const val = values[i];
        if(val==null || !isFinite(val)) { emaArr.push(null); continue; }
        if(prev==null){ prev = val; emaArr.push(val); }
        else { prev = val*k + prev*(1-k); emaArr.push(Number(prev.toFixed(4))); }
      }
      return emaArr;
    }

    function calcRSI(prices, period){
      if(!prices || prices.length===0) return [];
      const changes = [null];
      for(let i=1;i<prices.length;i++) changes.push(prices[i]-prices[i-1]);
      let avgGain=0, avgLoss=0;
      for(let i=1;i<=period && i<changes.length;i++){
        const c = changes[i]||0; avgGain += Math.max(0,c); avgLoss += Math.max(0,-c);
      }
      avgGain/=period; avgLoss/=period;
      const rsi = Array(prices.length).fill(null);
      for(let i=period+1;i<changes.length;i++){
        const c = changes[i]||0;
        const gain = Math.max(0,c), loss = Math.max(0,-c);
        avgGain = (avgGain*(period-1)+gain)/period;
        avgLoss = (avgLoss*(period-1)+loss)/period;
        const rs = avgLoss===0? 100 : avgGain/avgLoss;
        rsi[i] = Number((100 - 100/(1+rs)).toFixed(2));
      }
      return rsi;
    }

    function calcMACD(prices, fast=12, slow=26, signal=9){
      const fastEma = ema(prices, fast);
      const slowEma = ema(prices, slow);
      const macdLine = prices.map((_,i)=> (fastEma[i]!=null && slowEma[i]!=null)? Number((fastEma[i]-slowEma[i]).toFixed(4)) : null);
      const signalLine = ema(macdLine.map(v=>v==null? null : v), signal);
      const hist = prices.map((_,i)=> (macdLine[i]!=null && signalLine[i]!=null)? Number((macdLine[i]-signalLine[i]).toFixed(4)) : null);
      return { macdLine, signalLine, hist };
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      const toggleMA = document.getElementById('toggleMA');
      const toggleRSI = document.getElementById('toggleRSI');
      const toggleMACD = document.getElementById('toggleMACD');
      if(toggleMA){ toggleMA.addEventListener('change', ()=>{ // 重新載入以套用顯示狀態
        const code = document.getElementById('ta-code').value.trim();
        if(code) loadTaChart();
      }); }
      if(toggleRSI){ toggleRSI.addEventListener('change', ()=>{
        const sec = document.getElementById('rsiSection');
        sec.style.display = toggleRSI.checked ? 'block' : 'none';
      }); }
      if(toggleMACD){ toggleMACD.addEventListener('change', ()=>{
        const sec = document.getElementById('macdSection');
        sec.style.display = toggleMACD.checked ? 'block' : 'none';
      }); }
    });
  </script>
</body>
</html>


